<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ford Property Services ‚Ä¢ Photo Notes</title>
<meta name="theme-color" content="#0b1220">

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b1220; --text:#e7eefc; --muted:#a9b7d3;
  --line:rgba(255,255,255,.14); --good:#22c55e; --bad:#ef4444; --info:#7dd3fc;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg)}
header{position:sticky;top:0;background:#0b1220;border-bottom:1px solid var(--line)}
.wrap{max-width:1100px;margin:auto;padding:14px}
main{max-width:1100px;margin:auto;padding:16px}
.card{background:#111a33;border:1px solid var(--line);border-radius:18px;padding:14px}
.row{display:flex;gap:8px;flex-wrap:wrap}
button{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);padding:10px 14px;border-radius:14px;font-weight:900}
button.good{border-color:rgba(34,197,94,.6)}
button.bad{border-color:rgba(239,68,68,.6)}
button.rec{border-color:#ef4444;box-shadow:0 0 0 2px rgba(239,68,68,.25) inset}
input,textarea{width:100%;background:rgba(0,0,0,.25);border:1px solid var(--line);color:var(--text);border-radius:14px;padding:10px}
textarea{min-height:90px;white-space:pre-wrap}
.grid{display:grid;gap:12px;margin-top:12px}
@media(min-width:800px){.grid{grid-template-columns:1fr 1fr}}
.photo{border:1px solid var(--line);border-radius:16px;padding:10px}
.thumb{background:#000;border-radius:14px;overflow:hidden;aspect-ratio:4/3}
.thumb img{width:100%;height:100%;object-fit:contain}
.live{font-size:12px;color:var(--info);min-height:16px}
#speechStatus{font-size:12px;color:#93c5fd;margin-top:6px}
</style>
</head>

<body>

<header>
  <div class="wrap row" style="justify-content:space-between">
    <strong>Ford Property Services ‚Äì Photo Notes</strong>
    <a href="../" style="color:#9ecbff;text-decoration:none;font-weight:900">‚Üê Dashboard</a>
  </div>
</header>

<main>
<div class="card">

<div class="row">
  <input id="address" placeholder="Property address">
  <input id="date" type="date" style="max-width:220px">
</div>

<div class="row" style="margin-top:8px">
  <button id="openCamera" class="good">üì∑ Camera</button>
  <button id="openGallery">üñºÔ∏è Gallery</button>
  <button id="createPdf" class="good">üßæ Create PDF</button>
</div>

<div id="speechStatus"></div>

<div id="photos" class="grid"></div>

</div>
</main>

<input id="galleryInput" type="file" accept="image/*" multiple hidden>

<script>
const $ = id=>document.getElementById(id);
const STORE="fps_photo_notes_v6";
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;

let state={address:"",date:"",photos:[]};
let rec=null, wantRecording=false;
let committedHistory=[];

function todayISO(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}

/* ---------- load ---------- */
(function(){
  const raw=localStorage.getItem(STORE);
  if(raw) state=JSON.parse(raw);
  $("address").value=state.address||"";
  $("date").value=state.date||todayISO();
  state.date=$("date").value;
  render();
})();

$("address").oninput=e=>{state.address=e.target.value;save();}
$("date").onchange=e=>{state.date=e.target.value;save();}

function save(){
  localStorage.setItem(STORE,JSON.stringify(state));
}

/* ---------- camera ---------- */
$("openCamera").onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  const v=document.createElement("video");
  v.srcObject=stream; await v.play();
  setTimeout(()=>{
    const c=document.createElement("canvas");
    c.width=v.videoWidth; c.height=v.videoHeight;
    c.getContext("2d").drawImage(v,0,0);
    stream.getTracks().forEach(t=>t.stop());
    state.photos.push({img:c.toDataURL("image/jpeg",0.95),note:"",history:[]});
    save(); render();
  },800);
};

/* ---------- gallery ---------- */
$("openGallery").onclick=()=>$("galleryInput").click();
$("galleryInput").onchange=async e=>{
  for(const f of e.target.files){
    const img=new Image(); img.src=URL.createObjectURL(f); await img.decode();
    const c=document.createElement("canvas");
    c.width=img.width; c.height=img.height;
    c.getContext("2d").drawImage(img,0,0);
    state.photos.push({img:c.toDataURL("image/jpeg",0.95),note:"",history:[]});
  }
  save(); render();
};

/* ---------- dictation ---------- */
function normalise(t){
  return t.toLowerCase().replace(/[^\w\s]/g,"").replace(/\s+/g," ").trim();
}

function appendBullet(photo, textarea, text){
  const clean=text.trim();
  if(!clean) return;
  const norm=normalise(clean);
  if(photo.history.includes(norm)) return;

  photo.history.push(norm);
  const line="‚Ä¢ "+clean;
  textarea.value += (textarea.value? "\n":"")+line;
  photo.note=textarea.value;
  save();
}

function toggleDictate(photo, textarea, btn, live){
  if(wantRecording){
    wantRecording=false;
    rec && rec.stop();
    btn.textContent="üé§ Dictate";
    btn.classList.remove("rec");
    committedHistory=[];
    return;
  }

  wantRecording=true;
  committedHistory=[];
  btn.textContent="‚èπ Stop";
  btn.classList.add("rec");
  $("speechStatus").textContent="Recording‚Ä¶ speak, pause for new bullet";

  rec=new SR();
  rec.lang="en-GB";
  rec.interimResults=true;
  rec.continuous=true;

  let interim="";
  let timer=null;

  function commit(){
    if(interim){
      appendBullet(photo,textarea,interim);
      interim="";
      live.textContent="";
    }
  }

  rec.onresult=e=>{
    for(const r of e.results){
      const t=r[0].transcript;
      if(r.isFinal){
        appendBullet(photo,textarea,t);
        interim="";
      }else{
        interim=t;
        live.textContent="‚Ä¶ "+t;
        clearTimeout(timer);
        timer=setTimeout(commit,900);
      }
    }
  };

  rec.onend=()=>{
    commit();
    if(wantRecording) setTimeout(()=>rec.start(),300);
  };

  rec.start();
}

/* ---------- render ---------- */
function render(){
  const box=$("photos");
  box.innerHTML="";
  state.photos.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="photo";
    d.innerHTML=`
      <div class="thumb"><img src="${p.img}"></div>
      <textarea>${p.note||""}</textarea>
      <div class="live"></div>
      <div class="row" style="margin-top:6px">
        <button class="good">üé§ Dictate</button>
        <button>‚Ü© Undo</button>
        <button class="bad">üóëÔ∏è Delete</button>
      </div>`;
    const ta=d.querySelector("textarea");
    const live=d.querySelector(".live");
    ta.oninput=e=>{p.note=e.target.value;save();};

    d.querySelector(".good").onclick=()=>toggleDictate(p,ta,d.querySelector(".good"),live);

    d.querySelectorAll("button")[1].onclick=()=>{
      const lines=p.note.split("\n");
      lines.pop();
      p.note=lines.join("\n");
      ta.value=p.note;
      p.history.pop();
      save();
    };

    d.querySelector(".bad").onclick=()=>{
      state.photos.splice(i,1);
      save(); render();
    };

    box.appendChild(d);
  });
}

/* ---------- PDF ---------- */
$("createPdf").onclick=()=>{
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  let y=15;
  pdf.text("Ford Property Services",10,y); y+=8;
  pdf.text("Address: "+state.address,10,y); y+=6;
  pdf.text("Date: "+state.date.split("-").reverse().join("/"),10,y); y+=10;

  state.photos.forEach((p,i)=>{
    if(y>230){pdf.addPage(); y=15;}
    pdf.text("Photo "+(i+1),10,y); y+=6;
    pdf.addImage(p.img,"JPEG",10,y,90,60); y+=65;
    pdf.text(pdf.splitTextToSize(p.note||"‚Äî",180),10,y); y+=10;
  });

  const name=`Photo Notes ${state.address} ${state.date}.pdf`.replace(/[\/\\:*?"<>|]/g,"-");
  pdf.save(name);
};
</script>
</body>
</html>
