<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ford Property Services ‚Ä¢ Photo Notes</title>
<meta name="theme-color" content="#0b1220">

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b1220; --text:#e7eefc; --muted:#a9b7d3;
  --line:rgba(255,255,255,.14); --good:#22c55e; --bad:#ef4444; --info:#7dd3fc;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg)}
header{position:sticky;top:0;z-index:10;background:#0b1220;border-bottom:1px solid var(--line)}
.wrap{max-width:1100px;margin:auto;padding:14px}
main{max-width:1100px;margin:auto;padding:16px}
.card{background:#111a33;border:1px solid var(--line);border-radius:18px;padding:14px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button{
  border:1px solid var(--line);background:rgba(255,255,255,.06);
  color:var(--text);padding:10px 14px;border-radius:14px;font-weight:900
}
button.good{border-color:rgba(34,197,94,.6)}
button.bad{border-color:rgba(239,68,68,.6)}
button:disabled{opacity:.6}
input,textarea{
  width:100%;background:rgba(0,0,0,.25);
  border:1px solid var(--line);color:var(--text);
  border-radius:14px;padding:10px
}
textarea{min-height:90px;white-space:pre-wrap}
.grid{display:grid;gap:12px;margin-top:12px}
@media(min-width:800px){.grid{grid-template-columns:1fr 1fr}}
.photo{border:1px solid var(--line);border-radius:16px;padding:10px}
.thumb{background:#000;border-radius:14px;overflow:hidden;aspect-ratio:4/3}
.thumb img{width:100%;height:100%;object-fit:contain}
.live{font-size:12px;color:var(--info);min-height:16px}
.back{color:#9ecbff;text-decoration:none;font-weight:900}
#speechStatus{font-size:12px;color:#93c5fd;margin-top:6px}
</style>
</head>

<body>

<header>
  <div class="wrap row" style="justify-content:space-between">
    <strong>Ford Property Services ‚Ä¢ Photo Notes</strong>
    <a class="back" href="../dashboard/">‚Üê Dashboard</a>
  </div>
</header>

<main>
<div class="card">

<div class="row">
  <input id="address" placeholder="Property address">
  <input id="date" type="date" style="max-width:220px">
</div>

<div class="row" style="margin-top:8px">
  <button id="openCamera" class="good">üì∑ Camera</button>
  <button id="openGallery">üñºÔ∏è Gallery</button>
  <button id="createPdf" class="good">üßæ Create PDF</button>
  <button id="sharePdf" disabled>üì§ Share PDF</button>
</div>

<div id="speechStatus"></div>
<div id="photos" class="grid"></div>

</div>
</main>

<input id="galleryInput" type="file" accept="image/*" multiple hidden>

<script>
const $=id=>document.getElementById(id);
const STORE="fps_photo_notes_v12_share";

let state={address:"",date:"",photos:[]};
let lastPdfBlob=null;
let lastPdfName="";

function todayISO(){return new Date().toISOString().slice(0,10)}
function save(){localStorage.setItem(STORE,JSON.stringify(state))}
function load(){
  const raw=localStorage.getItem(STORE);
  if(raw) state=JSON.parse(raw);
  $("address").value=state.address||"";
  $("date").value=state.date||todayISO();
  state.date=$("date").value;
}
$("address").oninput=e=>{state.address=e.target.value;save()}
$("date").onchange=e=>{state.date=e.target.value;save()}

function render(){
  const box=$("photos");box.innerHTML="";
  state.photos.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="photo";
    d.innerHTML=`
      <div class="thumb"><img src="${p.img}"></div>
      <textarea>${p.note||""}</textarea>
      <div class="row" style="margin-top:6px">
        <button class="bad">üóëÔ∏è Delete</button>
      </div>`;
    const ta=d.querySelector("textarea");
    ta.oninput=e=>{p.note=e.target.value;save()};
    d.querySelector("button").onclick=()=>{
      state.photos.splice(i,1);save();render()
    };
    box.appendChild(d)
  })
}

$("openCamera").onclick=async()=>{
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  const v=document.createElement("video");v.srcObject=s;await v.play();
  setTimeout(()=>{
    const c=document.createElement("canvas");
    c.width=v.videoWidth;c.height=v.videoHeight;
    c.getContext("2d").drawImage(v,0,0);
    s.getTracks().forEach(t=>t.stop());
    state.photos.push({img:c.toDataURL("image/jpeg",0.95),note:""});
    save();render()
  },700)
};

$("openGallery").onclick=()=>$("galleryInput").click();
$("galleryInput").onchange=async e=>{
  for(const f of e.target.files){
    const img=new Image();img.src=URL.createObjectURL(f);await img.decode();
    const c=document.createElement("canvas");
    c.width=img.width;c.height=img.height;
    c.getContext("2d").drawImage(img,0,0);
    state.photos.push({img:c.toDataURL("image/jpeg",0.95),note:""})
  }
  save();render()
};

$("createPdf").onclick=()=>{
  if(!state.address||!state.photos.length){alert("Add address and photos first");return}

  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();let y=15;
  pdf.text("Ford Property Services",10,y);y+=8;
  pdf.text("Address: "+state.address,10,y);y+=6;
  pdf.text("Date: "+state.date.split("-").reverse().join("/"),10,y);y+=10;

  state.photos.forEach((p,i)=>{
    if(y>230){pdf.addPage();y=15}
    pdf.text("Photo "+(i+1),10,y);y+=8;
    pdf.addImage(p.img,"JPEG",10,y,90,60);y+=66;
    const lines=pdf.splitTextToSize(p.note||"‚Äî",180);
    pdf.text(lines,10,y);y+=lines.length*6+10
  });

  lastPdfBlob = pdf.output("blob");
  lastPdfName = `Photo Notes ${state.address} ${state.date}.pdf`
    .replace(/[\/\\:*?"<>|]/g,"-");

  $("sharePdf").disabled=false;
  alert("PDF created. Tap Share PDF.");
};

$("sharePdf").onclick=async()=>{
  if(!lastPdfBlob){alert("Create PDF first");return}
  const file=new File([lastPdfBlob],lastPdfName,{type:"application/pdf"});

  if(navigator.canShare && navigator.canShare({files:[file]})){
    await navigator.share({files:[file],title:lastPdfName});
  }else{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(lastPdfBlob);
    a.download=lastPdfName;
    a.click();
  }
};

load();render();
</script>
</body>
</html>
