<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ford Property Services • Inspection Report</title>

  <!-- PWA -->
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --text:#e7eefc;
      --muted:#a9b7d3;
      --line:rgba(255,255,255,.14);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(74,163,255,.20), transparent 60%),
        radial-gradient(1000px 600px at 100% 0%, rgba(34,197,94,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background: rgba(11,18,32,.84);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:46px;height:46px;border-radius:12px;
      background: linear-gradient(135deg, rgba(74,163,255,.9), rgba(74,163,255,.2));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      overflow:hidden;
      cursor:pointer;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:none}
    .brand h1{margin:0;font-size:16px;line-height:1.1}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
    }
    .pill strong{color:var(--text)}
    button{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
    }
    button.primary{
      background: linear-gradient(135deg, rgba(74,163,255,.95), rgba(74,163,255,.35));
      border-color: rgba(74,163,255,.5);
    }
    button.danger{
      background: linear-gradient(135deg, rgba(239,68,68,.9), rgba(239,68,68,.25));
      border-color: rgba(239,68,68,.45);
    }

    main{max-width:980px;margin:0 auto;padding:16px}
    .card{
      background: linear-gradient(180deg, rgba(15,27,51,.92), rgba(12,23,48,.92));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .stack{display:grid;gap:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .sectionTitle{
      font-weight:900; letter-spacing:.4px; font-size:12px;
      color: var(--text); opacity:.95;
      margin:2px 0 10px; text-transform:uppercase;
    }

    .reportHeader{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius2);
    }
    .rhLeft .bigTitle{font-size:18px;font-weight:950;margin:0}
    .rhRight{
      display:grid; gap:6px; min-width:260px;
      color:var(--muted); font-size:12px;
    }
    .rhRight b{color:var(--text)}
    .statusLine{
      margin-top:6px;
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-weight:900; letter-spacing:.2px;
    }

    .grid2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){ .grid2{grid-template-columns:1fr 1fr} }
    .kv{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius2);
      padding:10px;
    }
    .kv .k{color:var(--muted);font-size:12px}
    .kv .v{color:var(--text);font-weight:800;margin-top:4px;word-break:break-word}

    .chip{
      display:inline-flex; gap:10px; align-items:center;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      user-select:none;
    }
    .chip input{width:auto;transform:scale(1.1)}
    .hint{color:var(--muted);font-size:12px;margin:8px 0 0}

    .billingBar{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius2);
      padding:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width:720px){
      .billingBar{ grid-template-columns: 1fr 1fr; }
    }
    .billItem{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .billItem .chip{margin:0;}
    .billItem input{max-width:260px;}

    .evidence{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius2);
      padding:10px;
      display:flex; justify-content:space-between;
      gap:10px; flex-wrap:wrap; align-items:center;
    }
    .evidence .line{color:var(--text); font-weight:850;}
    .checkWrap{display:flex; gap:10px; flex-wrap:wrap;}

    .photoCols{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){ .photoCols{grid-template-columns:1fr 1fr} }
    .photoBox{
      border:1px dashed rgba(255,255,255,.22);
      border-radius: var(--radius2);
      padding:10px;
      background: rgba(255,255,255,.04);
    }
    .photoTop{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .photoTop .title{font-weight:950;letter-spacing:.2px}
    .btnRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .thumbs{
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap:8px; margin-top:10px;
    }
    .thumb{
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      aspect-ratio: 1 / 1;
      display:grid;place-items:center;
      position:relative;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb button{
      position:absolute;top:6px;right:6px;
      padding:6px 8px;border-radius:10px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      font-size:12px;
      font-weight:900;
    }

    .sigWrap{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius2);
      padding:10px;
    }
    .sigBox{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      overflow:hidden;
    }
    canvas{width:100%;height:180px;display:block;touch-action:none}
    .sigBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    footer{color:var(--muted);text-align:center;padding:18px 10px 30px;font-size:12px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" id="logoBox" title="Tap to upload logo">
          <span id="logoFallback" style="font-weight:950;letter-spacing:.4px;">FPS</span>
          <img id="logoImg" alt="Company logo" />
        </div>
        <div>
          <h1>Ford Property Services</h1>
          <p>Inspection Report</p>
        </div>
      </div>

      <div class="actions">
        <span class="pill"><strong>Report ID:</strong> <span id="reportIdText"></span></span>
        <span class="pill"><strong>Finalised:</strong> <span id="finalisedText">—</span></span>
        <button id="newBtn" class="danger" type="button">New Report</button>
        <button id="pdfBtn" class="primary" type="button">Generate PDF</button>
      </div>
    </div>
  </div>
</header>

<input id="logoInput" type="file" accept="image/*" style="display:none" />

<main>
  <div class="card stack">

    <div class="reportHeader">
      <div class="rhLeft">
        <div style="text-transform:uppercase;font-weight:950;font-size:12px;letter-spacing:.4px;opacity:.9;">
          Ford Property Services
        </div>
        <h2 class="bigTitle" style="margin-top:6px;">Inspection Report</h2>
        <div class="statusLine">FINAL / COMPLETED</div>
      </div>

      <div class="rhRight">
        <div><b>Report ID:</b> <span id="rhReportId"></span></div>
        <div><b>Finalised:</b> <span id="rhFinalised">—</span></div>
        <div><b>Date Completed:</b> <span id="dateCompletedText"></span></div>
      </div>
    </div>

    <!-- Billing strip near top -->
    <div>
      <div class="sectionTitle">Billing</div>
      <div class="billingBar">
        <div class="billItem">
          <label class="chip">
            <input id="invoiceRequired" type="checkbox" />
            Invoice Required
          </label>
          <div style="flex:1;min-width:180px;max-width:320px">
            <label>Invoice Number</label>
            <input id="invoiceNumber" placeholder="e.g., INV-1007" />
          </div>
        </div>

        <div class="billItem">
          <label class="chip">
            <input id="estimateRequired" type="checkbox" />
            Estimate Required
          </label>
          <div style="flex:1;min-width:180px;max-width:320px">
            <label>Estimate Amount (£)</label>
            <input id="estimateAmount" inputmode="decimal" placeholder="e.g., 250.00" />
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="sectionTitle">Job Details</div>
      <div class="grid2">
        <div class="kv">
          <div class="k">Letting Agent</div>
          <div class="v"><input id="lettingAgent" placeholder="e.g., Romans" /></div>
        </div>
        <div class="kv">
          <div class="k">Job Reference</div>
          <div class="v"><input id="jobRef" placeholder="Optional" /></div>
        </div>
        <div class="kv" style="grid-column:1/-1;">
          <div class="k">Property Address</div>
          <div class="v"><input id="propertyAddress" placeholder="Full address" /></div>
        </div>

        <div class="kv">
          <div class="k">Date Completed (UK format)</div>
          <div class="v"><input id="dateCompletedUK" inputmode="numeric" placeholder="DD/MM/YYYY" /></div>
          <div class="hint">Type date as DD/MM/YYYY (e.g., 05/01/2026).</div>
        </div>

        <div class="kv">
          <div class="k">Completed By</div>
          <div class="v" style="padding-top:10px;font-weight:950;">Ford Property Services</div>
        </div>
      </div>
    </div>

    <div>
      <div class="sectionTitle">Photo Evidence</div>
      <div class="evidence">
        <div class="line">
          Before photos taken: <span id="beforeMark">✘</span>
          &nbsp;&nbsp; After photos taken: <span id="afterMark">✘</span>
        </div>
        <div class="checkWrap">
          <label class="chip"><input id="beforeTick" type="checkbox" /> Before photos taken</label>
          <label class="chip"><input id="afterTick" type="checkbox" /> After photos taken</label>
        </div>
      </div>
    </div>

    <div>
      <div class="sectionTitle">Works / Inspection Notes</div>
      <textarea id="worksNotes" placeholder="Type inspection notes / works / condition notes here..."></textarea>
    </div>

    <div class="photoCols">
      <div class="photoBox">
        <div class="photoTop">
          <div class="title">BEFORE PHOTOS (UP TO 6)</div>
          <div class="pill"><strong>Count:</strong> <span id="beforeCount">0</span>/6</div>
        </div>
        <div class="btnRow">
          <button type="button" id="beforeGalleryBtn">Add from Gallery</button>
          <button type="button" id="beforeCameraBtn">Take Photo</button>
        </div>
        <input id="beforeGalleryInput" type="file" accept="image/*" multiple style="display:none" />
        <input id="beforeCameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
        <div class="thumbs" id="beforeThumbs"></div>
        <p class="hint" id="beforeEmptyHint">No photos added</p>
      </div>

      <div class="photoBox">
        <div class="photoTop">
          <div class="title">AFTER PHOTOS (UP TO 6)</div>
          <div class="pill"><strong>Count:</strong> <span id="afterCount">0</span>/6</div>
        </div>
        <div class="btnRow">
          <button type="button" id="afterGalleryBtn">Add from Gallery</button>
          <button type="button" id="afterCameraBtn">Take Photo</button>
        </div>
        <input id="afterGalleryInput" type="file" accept="image/*" multiple style="display:none" />
        <input id="afterCameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
        <div class="thumbs" id="afterThumbs"></div>
        <p class="hint" id="afterEmptyHint">No photos added</p>
      </div>
    </div>

    <div>
      <div class="sectionTitle">Extra Attachments</div>
      <label class="chip" style="display:inline-flex">
        <input id="extraAttachments" type="checkbox" />
        Photo / Video files attached to email
      </label>
    </div>

    <div class="sigWrap">
      <div class="sectionTitle">Signature</div>
      <div class="hint" style="margin-top:-6px;margin-bottom:10px;">Signed on device • Sign-off</div>

      <div class="sigBox">
        <canvas id="sig"></canvas>
      </div>

      <div class="sigBtns">
        <button type="button" id="clearSigBtn">Clear Signature</button>
        <button type="button" id="saveLocalBtn">Save Draft</button>
        <button type="button" id="loadLocalBtn">Load Draft</button>
      </div>

      <div class="divider"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px">
        <div><b style="color:var(--text)">Finalised:</b> <span id="sigFinalised">—</span></div>
        <div><b style="color:var(--text)">Report ID:</b> <span id="sigReportId"></span></div>
      </div>
    </div>

  </div>
</main>

<footer>Ford Property Services • Inspection Report</footer>

<script>
  // Register SW (PWA)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }

  // Helpers
  function pad2(n){ return String(n).padStart(2,'0'); }
  function ukDate(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`; }
  function ukDateTime(d){ return `${ukDate(d)}, ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`; }
  function isValidUKDate(s){
    const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec((s||"").trim());
    if(!m) return false;
    const dd = +m[1], mm = +m[2], yyyy = +m[3];
    const d = new Date(yyyy, mm-1, dd);
    return d.getFullYear()===yyyy && (d.getMonth()+1)===mm && d.getDate()===dd;
  }
  function makeReportId(){
    const d = new Date();
    const dd = pad2(d.getDate());
    const mm = pad2(d.getMonth()+1);
    const yyyy = d.getFullYear();
    const letters = "ABCDEFGHJKLMNPQRSTUVWXYZ";
    let tail = "";
    for(let i=0;i<5;i++) tail += letters[Math.floor(Math.random()*letters.length)];
    return `FPS-${dd}-${mm}-${yyyy}-${tail}`;
  }
  async function fileToDataURL(file, maxDim=1400, quality=0.80){
    const img = await new Promise((res, rej)=>{
      const i = new Image();
      i.onload=()=>res(i);
      i.onerror=rej;
      i.src = URL.createObjectURL(file);
    });
    const canvas = document.createElement('canvas');
    let {width:w, height:h} = img;
    const scale = Math.min(1, maxDim / Math.max(w,h));
    w = Math.round(w*scale); h = Math.round(h*scale);
    canvas.width=w; canvas.height=h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    const dataUrl = canvas.toDataURL('image/jpeg', quality);
    URL.revokeObjectURL(img.src);
    return dataUrl;
  }

  const state = { reportId: makeReportId(), finalised: null, beforePhotos: [], afterPhotos: [], logoDataUrl: null };

  // Elements
  const reportIdText = document.getElementById('reportIdText');
  const finalisedText = document.getElementById('finalisedText');
  const rhReportId = document.getElementById('rhReportId');
  const rhFinalised = document.getElementById('rhFinalised');
  const dateCompletedText = document.getElementById('dateCompletedText');
  const sigFinalised = document.getElementById('sigFinalised');
  const sigReportId = document.getElementById('sigReportId');

  const beforeTick = document.getElementById('beforeTick');
  const afterTick = document.getElementById('afterTick');
  const beforeMark = document.getElementById('beforeMark');
  const afterMark = document.getElementById('afterMark');

  const beforeCount = document.getElementById('beforeCount');
  const afterCount = document.getElementById('afterCount');
  const beforeEmptyHint = document.getElementById('beforeEmptyHint');
  const afterEmptyHint = document.getElementById('afterEmptyHint');
  const beforeThumbs = document.getElementById('beforeThumbs');
  const afterThumbs = document.getElementById('afterThumbs');

  const lettingAgent = document.getElementById('lettingAgent');
  const jobRef = document.getElementById('jobRef');
  const propertyAddress = document.getElementById('propertyAddress');
  const dateCompletedUK = document.getElementById('dateCompletedUK');

  const invoiceRequired = document.getElementById('invoiceRequired');
  const invoiceNumber = document.getElementById('invoiceNumber');
  const estimateRequired = document.getElementById('estimateRequired');
  const estimateAmount = document.getElementById('estimateAmount');

  const worksNotes = document.getElementById('worksNotes');
  const extraAttachments = document.getElementById('extraAttachments');

  const logoBox = document.getElementById('logoBox');
  const logoInput = document.getElementById('logoInput');
  const logoImg = document.getElementById('logoImg');
  const logoFallback = document.getElementById('logoFallback');

  const beforeGalleryBtn = document.getElementById('beforeGalleryBtn');
  const beforeCameraBtn  = document.getElementById('beforeCameraBtn');
  const afterGalleryBtn  = document.getElementById('afterGalleryBtn');
  const afterCameraBtn   = document.getElementById('afterCameraBtn');

  const beforeGalleryInput = document.getElementById('beforeGalleryInput');
  const beforeCameraInput  = document.getElementById('beforeCameraInput');
  const afterGalleryInput  = document.getElementById('afterGalleryInput');
  const afterCameraInput   = document.getElementById('afterCameraInput');

  const newBtn = document.getElementById('newBtn');
  const pdfBtn = document.getElementById('pdfBtn');
  const saveLocalBtn = document.getElementById('saveLocalBtn');
  const loadLocalBtn = document.getElementById('loadLocalBtn');

  // Defaults
  dateCompletedUK.value = ukDate(new Date());

  // UI
  function setFinalisedUI(){
    const t = state.finalised ? ukDateTime(state.finalised) : "—";
    finalisedText.textContent = t;
    rhFinalised.textContent = t;
    sigFinalised.textContent = t;
  }
  function setReportIdUI(){
    reportIdText.textContent = state.reportId;
    rhReportId.textContent = state.reportId;
    sigReportId.textContent = state.reportId;
  }
  function setDateCompletedUI(){
    dateCompletedText.textContent = isValidUKDate(dateCompletedUK.value) ? dateCompletedUK.value.trim() : "—";
  }
  function updateEvidenceMarks(){
    beforeMark.textContent = beforeTick.checked ? "✔" : "✘";
    afterMark.textContent  = afterTick.checked ? "✔" : "✘";
  }
  function updatePhotoCounts(){
    beforeCount.textContent = state.beforePhotos.length;
    afterCount.textContent = state.afterPhotos.length;
    beforeEmptyHint.style.display = state.beforePhotos.length ? "none" : "block";
    afterEmptyHint.style.display = state.afterPhotos.length ? "none" : "block";
  }

  setReportIdUI(); setFinalisedUI(); setDateCompletedUI(); updateEvidenceMarks(); updatePhotoCounts();
  dateCompletedUK.addEventListener('input', setDateCompletedUI);
  beforeTick.addEventListener('change', updateEvidenceMarks);
  afterTick.addEventListener('change', updateEvidenceMarks);

  // Logo
  logoBox.addEventListener('click', ()=> logoInput.click());
  logoInput.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    state.logoDataUrl = await fileToDataURL(file, 900, 0.85);
    logoImg.src = state.logoDataUrl;
    logoImg.style.display = 'block';
    logoFallback.style.display = 'none';
  });

  // Photos
  function renderThumbs(list, container, onRemove){
    container.innerHTML = '';
    list.forEach((p, i)=>{
      const t = document.createElement('div');
      t.className = 'thumb';
      const img = document.createElement('img');
      img.src = p.dataUrl;
      const b = document.createElement('button');
      b.type='button';
      b.textContent = '×';
      b.addEventListener('click', ()=> onRemove(i));
      t.appendChild(img);
      t.appendChild(b);
      container.appendChild(t);
    });
  }
  function autoTickFromPhotos(){
    beforeTick.checked = state.beforePhotos.length > 0;
    afterTick.checked  = state.afterPhotos.length > 0;
    updateEvidenceMarks();
  }
  async function addPhotos(files, targetList, targetThumbs){
    const arr = Array.from(files || []);
    for(const f of arr){
      if(targetList.length >= 6) break;
      const dataUrl = await fileToDataURL(f, 1400, 0.80);
      targetList.push({dataUrl});
    }
    renderThumbs(targetList, targetThumbs, (i)=>{
      targetList.splice(i,1);
      renderThumbs(targetList, targetThumbs, arguments.callee);
      autoTickFromPhotos();
      updatePhotoCounts();
    });
    autoTickFromPhotos();
    updatePhotoCounts();
  }

  beforeGalleryBtn.addEventListener('click', ()=> beforeGalleryInput.click());
  beforeCameraBtn.addEventListener('click', ()=> beforeCameraInput.click());
  afterGalleryBtn.addEventListener('click', ()=> afterGalleryInput.click());
  afterCameraBtn.addEventListener('click', ()=> afterCameraInput.click());

  beforeGalleryInput.addEventListener('change', async (e)=>{ await addPhotos(e.target.files, state.beforePhotos, beforeThumbs); beforeGalleryInput.value=''; });
  beforeCameraInput.addEventListener('change', async (e)=>{ await addPhotos(e.target.files, state.beforePhotos, beforeThumbs); beforeCameraInput.value=''; });
  afterGalleryInput.addEventListener('change', async (e)=>{ await addPhotos(e.target.files, state.afterPhotos, afterThumbs); afterGalleryInput.value=''; });
  afterCameraInput.addEventListener('change', async (e)=>{ await addPhotos(e.target.files, state.afterPhotos, afterThumbs); afterCameraInput.value=''; });

  // Signature pad
  const canvas = document.getElementById('sig');
  const ctx = canvas.getContext('2d');
  let drawing = false, last = null;

  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.lineWidth = 2.4;
    ctx.lineCap = 'round';
    ctx.strokeStyle = 'rgba(231,238,252,.95)';
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function getPos(evt){
    const rect = canvas.getBoundingClientRect();
    const t = (evt.touches && evt.touches[0]) ? evt.touches[0] : evt;
    return { x: t.clientX - rect.left, y: t.clientY - rect.top };
  }
  function start(evt){ drawing = true; last = getPos(evt); }
  function move(evt){
    if(!drawing) return;
    evt.preventDefault();
    const p = getPos(evt);
    ctx.beginPath();
    ctx.moveTo(last.x,last.y);
    ctx.lineTo(p.x,p.y);
    ctx.stroke();
    last = p;
  }
  function end(){ drawing = false; last = null; }

  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('mousemove', move);
  canvas.addEventListener('mouseup', end);
  canvas.addEventListener('mouseleave', end);
  canvas.addEventListener('touchstart', start, {passive:false});
  canvas.addEventListener('touchmove', move, {passive:false});
  canvas.addEventListener('touchend', end);

  document.getElementById('clearSigBtn').addEventListener('click', ()=> ctx.clearRect(0,0,canvas.width,canvas.height));

  function signatureDataUrl(){
    const tmp = document.createElement('canvas');
    tmp.width = canvas.width; tmp.height = canvas.height;
    const empty = tmp.toDataURL('image/png');
    const cur = canvas.toDataURL('image/png');
    return (cur === empty) ? null : cur;
  }

  // Draft save/load
  function collectDraft(){
    return {
      state: {
        reportId: state.reportId,
        finalised: state.finalised ? state.finalised.toISOString() : null,
        beforePhotos: state.beforePhotos,
        afterPhotos: state.afterPhotos,
        logoDataUrl: state.logoDataUrl
      },
      fields: {
        lettingAgent: lettingAgent.value || "",
        jobRef: jobRef.value || "",
        propertyAddress: propertyAddress.value || "",
        dateCompletedUK: dateCompletedUK.value || "",
        invoiceRequired: !!invoiceRequired.checked,
        invoiceNumber: invoiceNumber.value || "",
        estimateRequired: !!estimateRequired.checked,
        estimateAmount: estimateAmount.value || "",
        beforeTick: !!beforeTick.checked,
        afterTick: !!afterTick.checked,
        worksNotes: worksNotes.value || "",
        extraAttachments: !!extraAttachments.checked,
        signature: canvas.toDataURL('image/png')
      }
    };
  }

  function applyDraft(d){
    if(!d) return;
    if(d.state){
      state.reportId = d.state.reportId || state.reportId;
      state.finalised = d.state.finalised ? new Date(d.state.finalised) : null;
      state.beforePhotos = d.state.beforePhotos || [];
      state.afterPhotos = d.state.afterPhotos || [];
      state.logoDataUrl = d.state.logoDataUrl || null;
    }
    if(d.fields){
      lettingAgent.value = d.fields.lettingAgent ?? "";
      jobRef.value = d.fields.jobRef ?? "";
      propertyAddress.value = d.fields.propertyAddress ?? "";
      dateCompletedUK.value = d.fields.dateCompletedUK ?? dateCompletedUK.value;

      invoiceRequired.checked = !!d.fields.invoiceRequired;
      invoiceNumber.value = d.fields.invoiceNumber ?? "";
      estimateRequired.checked = !!d.fields.estimateRequired;
      estimateAmount.value = d.fields.estimateAmount ?? "";

      beforeTick.checked = !!d.fields.beforeTick;
      afterTick.checked = !!d.fields.afterTick;
      worksNotes.value = d.fields.worksNotes ?? "";
      extraAttachments.checked = !!d.fields.extraAttachments;

      if(d.fields.signature){
        const img = new Image();
        img.onload = ()=>{
          resizeCanvas();
          ctx.drawImage(img,0,0,canvas.width/(window.devicePixelRatio||1), canvas.height/(window.devicePixelRatio||1));
        };
        img.src = d.fields.signature;
      }
    }

    if(state.logoDataUrl){
      logoImg.src = state.logoDataUrl;
      logoImg.style.display = 'block';
      logoFallback.style.display = 'none';
    }else{
      logoImg.style.display = 'none';
      logoFallback.style.display = 'block';
    }

    setReportIdUI(); setFinalisedUI(); setDateCompletedUI();
    renderThumbs(state.beforePhotos, beforeThumbs, (i)=>{ state.beforePhotos.splice(i,1); renderThumbs(state.beforePhotos,beforeThumbs,arguments.callee); autoTickFromPhotos(); updatePhotoCounts(); });
    renderThumbs(state.afterPhotos, afterThumbs, (i)=>{ state.afterPhotos.splice(i,1); renderThumbs(state.afterPhotos,afterThumbs,arguments.callee); autoTickFromPhotos(); updatePhotoCounts(); });
    updateEvidenceMarks(); updatePhotoCounts();
  }

  saveLocalBtn.addEventListener('click', ()=>{
    localStorage.setItem('fps_inspection_report_pwa_v3', JSON.stringify(collectDraft()));
    alert('Draft saved on this device.');
  });
  loadLocalBtn.addEventListener('click', ()=>{
    const raw = localStorage.getItem('fps_inspection_report_pwa_v3');
    if(!raw){ alert('No saved draft found.'); return; }
    applyDraft(JSON.parse(raw));
    alert('Draft loaded.');
  });

  // New report
  newBtn.addEventListener('click', ()=>{
    if(!confirm('Start a new report? This clears fields + photos (logo kept).')) return;

    state.reportId = makeReportId();
    state.finalised = null;
    state.beforePhotos = [];
    state.afterPhotos = [];

    lettingAgent.value = "";
    jobRef.value = "";
    propertyAddress.value = "";
    dateCompletedUK.value = ukDate(new Date());

    invoiceRequired.checked = false;
    invoiceNumber.value = "";
    estimateRequired.checked = false;
    estimateAmount.value = "";

    beforeTick.checked = false;
    afterTick.checked = false;
    worksNotes.value = "";
    extraAttachments.checked = false;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    setReportIdUI(); setFinalisedUI(); setDateCompletedUI();
    updateEvidenceMarks(); updatePhotoCounts();
    renderThumbs(state.beforePhotos, beforeThumbs, ()=>{});
    renderThumbs(state.afterPhotos, afterThumbs, ()=>{});
  });

  // PDF
  function tickLine(doc, label, checked, x, y){
    doc.setDrawColor(80);
    doc.rect(x, y-4, 4, 4);
    if(checked){
      doc.setLineWidth(0.6);
      doc.line(x+0.8, y-2.2, x+1.8, y-0.9);
      doc.line(x+1.8, y-0.9, x+3.4, y-3.2);
      doc.setLineWidth(0.35);
    }
    doc.setFont('helvetica','normal');
    doc.setFontSize(10);
    doc.setTextColor(40);
    doc.text(label, x+6, y-0.6);
  }

  pdfBtn.addEventListener('click', async ()=>{
    if(!isValidUKDate(dateCompletedUK.value)){
      alert("Please enter Date Completed in UK format DD/MM/YYYY (e.g., 05/01/2026).");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'mm', format:'a4'});

    state.finalised = new Date();
    setFinalisedUI();

    const margin = 12;
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();

    const data = {
      reportId: state.reportId,
      finalised: ukDateTime(state.finalised),
      lettingAgent: (lettingAgent.value || "").trim() || "-",
      jobRef: (jobRef.value || "").trim() || "-",
      propertyAddress: (propertyAddress.value || "").trim() || "-",
      dateCompleted: dateCompletedUK.value.trim(),
      invoiceRequired: !!invoiceRequired.checked,
      invoiceNumber: (invoiceNumber.value || "").trim() || "-",
      estimateRequired: !!estimateRequired.checked,
      estimateAmount: (estimateAmount.value || "").trim() || "-",
      completedBy: "Ford Property Services",
      beforeTaken: !!beforeTick.checked,
      afterTaken: !!afterTick.checked,
      worksNotes: (worksNotes.value || "").trim() || "-",
      extraAttachments: !!extraAttachments.checked,
      signature: signatureDataUrl()
    };

    function box(x,y,w,h){
      doc.setDrawColor(180);
      doc.setLineWidth(0.35);
      doc.roundedRect(x,y,w,h,2,2);
    }
    function upperLabel(txt, x, y){
      doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(20);
      doc.text(txt.toUpperCase(), x, y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(40);
    }

    // Header
    let y = 14;

    if(state.logoDataUrl){
      try{ doc.addImage(state.logoDataUrl, 'JPEG', margin, y-4, 18, 18); }catch(e){}
    }else{
      doc.setDrawColor(180);
      doc.rect(margin, y-4, 18, 18);
      doc.setFontSize(9);
      doc.text('LOGO', margin+4, y+6);
    }

    doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.setTextColor(20);
    doc.text('FORD PROPERTY SERVICES', margin+22, y+4);

    doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.setTextColor(30);
    doc.text('Inspection Report', margin+22, y+11);

    doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(20);
    doc.text('FINAL / COMPLETED', pageW - margin, y+4, {align:'right'});

    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(40);
    doc.text(`Report ID: ${data.reportId}`, pageW - margin, y+10, {align:'right'});
    doc.text(`Finalised: ${data.finalised}`, pageW - margin, y+15, {align:'right'});

    y += 20;

    // Job details + invoice/estimate on right
    upperLabel('Job Details', margin, y);
    y += 4;

    const jobH = 64;
    box(margin, y, pageW - margin*2, jobH);

    doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(20);
    doc.text('Letting Agent', margin+4, y+10);
    doc.text('Job Reference', margin+4, y+20);
    doc.text('Property Address', margin+4, y+30);
    doc.text('Date Completed', margin+4, y+40);
    doc.text('Completed By', margin+110, y+10);

    doc.text('Invoice', margin+110, y+24);
    doc.text('Invoice Number', margin+110, y+34);
    doc.text('Estimate', margin+110, y+44);
    doc.text('Estimate Amount (£)', margin+110, y+54);

    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(40);
    doc.text(data.lettingAgent, margin+45, y+10);
    doc.text(data.jobRef, margin+45, y+20);
    doc.text(doc.splitTextToSize(data.propertyAddress, 88), margin+45, y+30);
    doc.text(data.dateCompleted, margin+45, y+40);
    doc.text(data.completedBy, margin+150, y+10);

    tickLine(doc, 'Required', data.invoiceRequired, margin+150, y+24);
    doc.text(data.invoiceNumber, margin+150, y+34);

    tickLine(doc, 'Required', data.estimateRequired, margin+150, y+44);
    doc.text(data.estimateAmount, margin+150, y+54);

    y += jobH + 10;

    // Photo evidence
    upperLabel('Photo Evidence', margin, y);
    y += 4;
    box(margin, y, pageW - margin*2, 14);

    const beforeMarkPdf = data.beforeTaken ? '✔' : '✘';
    const afterMarkPdf  = data.afterTaken ? '✔' : '✘';

    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(40);
    doc.text(`Before photos taken: ${beforeMarkPdf}    After photos taken: ${afterMarkPdf}`, margin+4, y+9);

    y += 22;

    // Notes
    upperLabel('Works / Inspection Notes', margin, y);
    y += 4;

    const notesLines = doc.splitTextToSize(data.worksNotes, pageW - margin*2 - 8);
    const notesH = Math.min(78, Math.max(30, notesLines.length * 5 + 10));
    box(margin, y, pageW - margin*2, notesH);
    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(40);
    doc.text(notesLines, margin+4, y+10);

    // Photos pages
    async function addPhotoPage(title, photos){
      doc.addPage();
      let py = 14;
      doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.setTextColor(20);
      doc.text(title.toUpperCase(), margin, py);
      py += 8;

      const gap = 4;
      const boxW = (pageW - margin*2 - gap) / 2;
      const boxH = 78;

      for(let i=0;i<photos.length;i++){
        const col = i % 2;
        const row = Math.floor(i / 2);
        const x = margin + col*(boxW + gap);
        const y0 = py + row*(boxH + gap);

        if(y0 + boxH + 12 > pageH){
          doc.addPage();
          py = 14;
          doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.setTextColor(20);
          doc.text((title + ' (cont.)').toUpperCase(), margin, py);
          py += 8;
          i--;
          continue;
        }

        doc.setDrawColor(180);
        doc.setLineWidth(0.35);
        doc.roundedRect(x, y0, boxW, boxH, 2,2);

        try{
          doc.addImage(photos[i].dataUrl, 'JPEG', x+2, y0+2, boxW-4, boxH-4, undefined, 'FAST');
        }catch(e){
          doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(40);
          doc.text('Image error', x+5, y0+10);
        }
      }
    }

    if(state.beforePhotos.length) await addPhotoPage('Before Photos (Up To 6)', state.beforePhotos);
    if(state.afterPhotos.length) await addPhotoPage('After Photos (Up To 6)', state.afterPhotos);

    // Signature page
    doc.addPage();
    let sy = 14;

    upperLabel('Extra Attachments', margin, sy);
    sy += 6;
    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(40);
    doc.text(data.extraAttachments ? 'Photo / Video files attached to email' : 'None', margin, sy);
    sy += 16;

    upperLabel('Signature', margin, sy);
    sy += 4;
    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(40);
    doc.text('Signed on device   Sign-off', margin, sy+6);

    box(margin, sy+10, pageW - margin*2, 55);
    if(data.signature){
      try{ doc.addImage(data.signature, 'PNG', margin+4, sy+14, 90, 40); }catch(e){}
    }else{
      doc.setTextColor(120);
      doc.text('No signature captured', margin+4, sy+22);
      doc.setTextColor(40);
    }

    doc.setTextColor(40);
    doc.text(`Finalised: ${data.finalised}`, margin, sy+74);
    doc.text(`Report ID: ${data.reportId}`, margin, sy+80);

    // Footer
    const total = doc.getNumberOfPages();
    for(let p=1;p<=total;p++){
      doc.setPage(p);
      doc.setFont('helvetica','normal');
      doc.setFontSize(9);
      doc.setTextColor(130);
      doc.text(`Report ID: ${data.reportId}`, margin, pageH - 8);
      doc.text(`Page ${p} of ${total}`, pageW - margin, pageH - 8, {align:'right'});
    }

    const safeName = `${data.reportId}.pdf`.replace(/[^\w\-\.]/g,'_');
    doc.save(safeName);
  });
</script>
</body>
</html>
