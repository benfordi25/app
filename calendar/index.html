<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Ford Property Services • Calendar</title>
<meta name="theme-color" content="#0b1220" />

<style>
:root{
  --bg:#0b1220;
  --card:rgba(15,27,51,.92);
  --card2:rgba(12,23,48,.92);
  --text:#e7eefc;
  --muted:#a9b7d3;
  --line:rgba(255,255,255,.14);
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --blue:#4aa3ff;
  --green:#22c55e;
  --purple:#a855f7;
}
*{box-sizing:border-box}
html,body{overflow-x:hidden;}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(1200px 650px at 20% -10%, rgba(74,163,255,.22), transparent 60%),
    radial-gradient(1000px 650px at 100% 0%, rgba(34,197,94,.12), transparent 55%),
    var(--bg);
  color:var(--text);
}
header{
  position:sticky;top:0;z-index:10;
  background:rgba(11,18,32,.82);
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--line);
}
.wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
.top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.btn{
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:8px 12px;
  border-radius:14px;
  font-weight:900;
  text-decoration:none;
  cursor:pointer;
  max-width:100%;
  white-space:nowrap;
}
.btn.primary{border-color:rgba(74,163,255,.35);background:rgba(74,163,255,.12)}
.btn.ok{border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.10)}
.btn.danger{border-color:rgba(239,68,68,.28);background:rgba(239,68,68,.10)}
main{max-width:1100px;margin:0 auto;padding:16px}
.card{
  background:linear-gradient(180deg,var(--card),var(--card2));
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:14px;
}
.toolbar{
  display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;
  margin-bottom:12px;
  gap:10px;
}
.toolbar > div{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}

.grid{
  display:grid;
  grid-template-columns:repeat(7, minmax(0, 1fr));
  gap:10px;
}
.dow{color:var(--muted);text-align:center;font-size:12px}
.day{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);
  border-radius:16px;
  min-height:90px;
  padding:8px;
  cursor:pointer;
  min-width:0;
}
.day.today{border-color:var(--blue);background:rgba(74,163,255,.10)}
.dayNum{font-weight:950;margin-bottom:4px}
.event{
  margin-top:6px;
  padding:6px 8px;
  border-radius:12px;
  font-size:12px;
  cursor:pointer;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14);
  max-width:100%;
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.event.est{border-left:4px solid var(--blue)}
.event.works{border-left:4px solid var(--green)}
.event.manual{border-left:4px solid var(--purple)}
.muted{color:var(--muted);font-size:12px}

/* Week view: mobile stacks vertically */
.week{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
@media(min-width:860px){
  .week{ grid-template-columns:repeat(7,1fr); }
}
.weekCol{
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  padding:10px;
  min-width:0;
}
.weekCol.today{border-color:var(--blue);background:rgba(74,163,255,.06)}
.weekHead{
  font-weight:950;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.badge{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--muted);
}

.list{display:grid;gap:10px}
.listItem{
  padding:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  cursor:pointer;
  min-width:0;
}

@media(max-width:520px){
  .wrap{padding:12px 12px}
  main{padding:12px}
  .card{padding:12px}
  .grid{gap:6px}
  .day{min-height:72px;padding:6px;border-radius:14px}
  .event{font-size:11px;padding:5px 6px;border-radius:11px}
  .btn{padding:8px 10px}
}

/* Dialog */
dialog{
  width:min(720px, 96vw);
  border:1px solid rgba(255,255,255,.16);
  border-radius:18px;
  padding:0;
  background: rgba(11,18,32,.95);
  color:var(--text);
  box-shadow: var(--shadow);
}
dialog::backdrop{ background: rgba(0,0,0,.55); }
.dlgHead{
  padding:14px 14px 10px;
  border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.dlgHead strong{ font-size:14px; }
.dlgBody{ padding:14px; display:grid; gap:10px; }
.field{display:grid; gap:6px;}
label{font-size:12px;color:var(--muted);}
input, textarea{
  width:100%;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color:var(--text);
  border-radius:14px;
  padding:10px 12px;
  outline:none;
}
textarea{min-height:110px; resize:vertical;}
.dlgActions{
  padding:14px;
  border-top:1px solid var(--line);
  display:flex;
  gap:10px;
  justify-content:flex-end;
  flex-wrap:wrap;
}
.two{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
}
@media(min-width:700px){
  .two{grid-template-columns: 1fr 1fr;}
}
.smallnote{color:var(--muted);font-size:12px}
</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <strong>Ford Property Services</strong><br>
        <span class="muted">Calendar</span>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn ok" id="newManualBtn" type="button">+ Manual</button>
        <a class="btn" href="../jobs-board/">Jobs Board</a>
      </div>
    </div>
  </div>
</header>

<main>
<div class="card">
  <div class="toolbar">
    <div>
      <button class="btn" id="prev">←</button>
      <strong id="title"></strong>
      <button class="btn" id="next">→</button>
    </div>
    <div>
      <button class="btn" id="monthBtn">Month</button>
      <button class="btn" id="weekBtn">Week</button>
      <button class="btn" id="dayBtn">Day</button>
      <button class="btn" id="todayBtn">Today</button>
    </div>
  </div>

  <div id="monthView">
    <div class="grid" id="dow"></div>
    <div class="grid" id="monthGrid"></div>
  </div>

  <div id="weekView" style="display:none"></div>
  <div id="dayView" style="display:none"></div>
</div>
</main>

<!-- Manual appointment dialog -->
<dialog id="manualDlg">
  <div class="dlgHead">
    <strong id="manualDlgTitle">Manual Appointment</strong>
    <button class="btn" id="manualClose" type="button">✕</button>
  </div>

  <div class="dlgBody">
    <div class="two">
      <div class="field">
        <label>Date</label>
        <input id="manDate" type="date" />
      </div>
      <div class="field">
        <label>Time</label>
        <input id="manTime" type="time" />
      </div>
    </div>

    <div class="field">
      <label>Address (first line shown)</label>
      <input id="manAddr" type="text" placeholder="e.g. 12 High Street" />
    </div>

    <div class="field">
      <label>Notes (optional)</label>
      <textarea id="manNotes" placeholder="Key details..."></textarea>
      <div class="smallnote">Manual appointments do not link to Jobs Board.</div>
    </div>
  </div>

  <div class="dlgActions">
    <button class="btn danger" id="manDelete" type="button" style="display:none">Delete</button>
    <button class="btn ok" id="manSave" type="button">Save</button>
  </div>
</dialog>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyCJPVdTvzHFRiyLTzR08hMTBp71gPEPLU8",
  authDomain:"fps-jobs-board.firebaseapp.com",
  projectId:"fps-jobs-board"
});
await signInAnonymously(getAuth(app));
const db = getFirestore(app);

/* ===== Manual appointments (local only, no Jobs Board link) ===== */
const MANUAL_KEY = "fps_calendar_manual_v1"; // { "YYYY-MM-DD": [ {id,time,address,notes} ] }

function loadManual(){
  try{
    const raw = localStorage.getItem(MANUAL_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj === "object") ? obj : {};
  }catch{ return {}; }
}
function saveManual(obj){
  localStorage.setItem(MANUAL_KEY, JSON.stringify(obj));
}
function uid(){
  return "man_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
let manual = loadManual();

/* ===== Jobs board bookings (from Firestore) ===== */
let jobs=[];
onSnapshot(doc(db,"jobsBoard","shared"),snap=>{
  jobs=snap.data()?.jobs||[];
  render();
});

const title=document.getElementById("title");
const monthGrid=document.getElementById("monthGrid");
const weekView=document.getElementById("weekView");
const dayView=document.getElementById("dayView");
const dow=document.getElementById("dow");
const monthView=document.getElementById("monthView");

["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].forEach(d=>{
  const el=document.createElement("div");
  el.className="dow";el.textContent=d;dow.appendChild(el);
});

let view=new Date(); view.setDate(1);
let selected=new Date();
let mode="month";

const pad2=n=>String(n).padStart(2,"0");
const iso=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const firstLine=a=>(a||"").split(",")[0].trim();

/* Build all events for a date:
   - jobs events have id + link
   - manual events have id but NO jobs link
*/
function eventsFor(dateISO){
  const out = [];

  // Jobs board feed
  for(const j of jobs){
    if(j.estVisitDT?.startsWith(dateISO)){
      out.push({
        t: j.estVisitDT.slice(11,16),
        a: firstLine(j.address),
        id: j.id,
        type: "est",
        src: "job"
      });
    }
    if(j.worksDT?.startsWith(dateISO)){
      out.push({
        t: j.worksDT.slice(11,16),
        a: firstLine(j.address),
        id: j.id,
        type: "works",
        src: "job"
      });
    }
  }

  // Manual events (local)
  const arr = Array.isArray(manual[dateISO]) ? manual[dateISO] : [];
  for(const e of arr){
    out.push({
      t: (e.time || "00:00"),
      a: (e.address || "").trim(),
      id: e.id,
      type: "manual",
      src: "manual"
    });
  }

  // Sort by time
  return out.sort((a,b)=> (a.t||"").localeCompare(b.t||""));
}

function setSelected(d){
  selected = new Date(d);
  view = new Date(selected.getFullYear(), selected.getMonth(), 1);
}

function render(){
  const titleDate = (mode==="month") ? view : selected;
  title.textContent = titleDate.toLocaleDateString("en-GB",{month:"long",year:"numeric"});

  monthGrid.innerHTML="";
  weekView.innerHTML="";
  dayView.innerHTML="";

  monthView.style.display=mode==="month"?"block":"none";
  weekView.style.display=mode==="week"?"block":"none";
  dayView.style.display=mode==="day"?"block":"none";

  const todayISO = iso(new Date());

  if(mode==="month"){
    const y=view.getFullYear(),m=view.getMonth();
    const first=new Date(y,m,1);
    const offset=(first.getDay()+6)%7;
    const days=new Date(y,m+1,0).getDate();

    for(let i=0;i<offset;i++){
      const blank=document.createElement("div");
      blank.className="day";
      blank.style.opacity="0";
      blank.style.pointerEvents="none";
      monthGrid.appendChild(blank);
    }

    for(let d=1;d<=days;d++){
      const date=new Date(y,m,d);
      const dISO = iso(date);

      const box=document.createElement("div");
      box.className="day"+(dISO===todayISO?" today":"");
      box.innerHTML=`<div class="dayNum">${d}</div>`;

      eventsFor(dISO).forEach(e=>{
        const ev=document.createElement("div");
        ev.className=`event ${e.type}`;
        ev.textContent=`${e.t} • ${e.a || "(No address)"}`;

        ev.onclick=(evt)=>{
          evt.stopPropagation();
          if(e.src === "job"){
            location.href=`../jobs-board/?job=${e.id}`;
          }else{
            openManualDialog(dISO, e.id);
          }
        };
        box.appendChild(ev);
      });

      box.onclick=()=>{
        setSelected(date);
        mode="day";
        render();
      };

      monthGrid.appendChild(box);
    }
  }

  if(mode==="week"){
    const base=new Date(selected);
    const start=new Date(base);
    start.setDate(base.getDate()-((base.getDay()+6)%7)); // Monday start
    weekView.className="week";

    for(let i=0;i<7;i++){
      const d=new Date(start); d.setDate(start.getDate()+i);
      const dISO = iso(d);
      const evs=eventsFor(dISO);

      const col=document.createElement("div");
      col.className="weekCol"+(dISO===todayISO?" today":"");

      col.innerHTML = `
        <div class="weekHead">
          <div>${d.toLocaleDateString("en-GB",{weekday:"long",day:"2-digit",month:"short"})}</div>
          <span class="badge">${evs.length} booking${evs.length===1?"":"s"}</span>
        </div>
      `;

      if(!evs.length){
        const none=document.createElement("div");
        none.className="muted";
        none.textContent="No bookings";
        col.appendChild(none);
      }else{
        evs.forEach(e=>{
          const ev=document.createElement("div");
          ev.className=`event ${e.type}`;
          ev.textContent=`${e.t} • ${e.a || "(No address)"}`;
          ev.onclick=(evt)=>{
            evt.stopPropagation();
            if(e.src === "job"){
              location.href=`../jobs-board/?job=${e.id}`;
            }else{
              openManualDialog(dISO, e.id);
            }
          };
          col.appendChild(ev);
        });
      }

      col.addEventListener("click",(evt)=>{
        if(evt.target.closest(".event")) return;
        setSelected(d);
        mode="day";
        render();
      });

      weekView.appendChild(col);
    }
  }

  if(mode==="day"){
    const dISO = iso(selected);
    const evs=eventsFor(dISO);

    const head=document.createElement("div");
    head.className="weekCol"+(dISO===todayISO?" today":"");
    head.innerHTML = `
      <div class="weekHead">
        <div>${selected.toLocaleDateString("en-GB",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})}</div>
        <span class="badge">${evs.length} appointment${evs.length===1?"":"s"}</span>
      </div>
    `;
    dayView.appendChild(head);

    const list=document.createElement("div");
    list.className="list";

    if(!evs.length){
      list.innerHTML=`<div class="muted">No appointments</div>`;
    }else{
      evs.forEach(e=>{
        const li=document.createElement("div");
        li.className="listItem";
        li.textContent=`${e.t} • ${e.a || "(No address)"}`;
        li.onclick=()=>{
          if(e.src === "job"){
            location.href=`../jobs-board/?job=${e.id}`;
          }else{
            openManualDialog(dISO, e.id);
          }
        };
        list.appendChild(li);
      });
    }
    dayView.appendChild(list);
  }
}

/* ===== Prev/Next + Today ===== */
document.getElementById("prev").onclick=()=>{
  if(mode==="month"){
    view.setMonth(view.getMonth()-1);
  }else if(mode==="week"){
    const d=new Date(selected); d.setDate(d.getDate()-7); setSelected(d);
  }else{
    const d=new Date(selected); d.setDate(d.getDate()-1); setSelected(d);
  }
  render();
};
document.getElementById("next").onclick=()=>{
  if(mode==="month"){
    view.setMonth(view.getMonth()+1);
  }else if(mode==="week"){
    const d=new Date(selected); d.setDate(d.getDate()+7); setSelected(d);
  }else{
    const d=new Date(selected); d.setDate(d.getDate()+1); setSelected(d);
  }
  render();
};
document.getElementById("todayBtn").onclick=()=>{
  setSelected(new Date());
  render();
};
document.getElementById("monthBtn").onclick=()=>{ mode="month"; render(); };
document.getElementById("weekBtn").onclick=()=>{ mode="week"; render(); };
document.getElementById("dayBtn").onclick=()=>{ mode="day"; render(); };

/* ===== Manual dialog logic ===== */
const manualDlg = document.getElementById("manualDlg");
const manualDlgTitle = document.getElementById("manualDlgTitle");
const manualClose = document.getElementById("manualClose");
const manDate = document.getElementById("manDate");
const manTime = document.getElementById("manTime");
const manAddr = document.getElementById("manAddr");
const manNotes = document.getElementById("manNotes");
const manDelete = document.getElementById("manDelete");
const manSave = document.getElementById("manSave");
const newManualBtn = document.getElementById("newManualBtn");

let editingManualId = null;

function openManualDialog(dateISO, manualId=null){
  const arr = Array.isArray(manual[dateISO]) ? manual[dateISO] : [];
  const existing = manualId ? arr.find(x=>x.id===manualId) : null;

  editingManualId = manualId || null;

  manualDlgTitle.textContent = existing ? "Edit Manual Appointment" : "New Manual Appointment";
  manDate.value = dateISO;
  manTime.value = existing?.time || "";
  manAddr.value = existing?.address || "";
  manNotes.value = existing?.notes || "";

  manDelete.style.display = existing ? "inline-flex" : "none";

  manualDlg.showModal();
}

manualClose.onclick = ()=> manualDlg.close();

newManualBtn.onclick = ()=>{
  const dISO = iso(new Date());
  setSelected(new Date());
  openManualDialog(dISO, null);
};

manSave.onclick = ()=>{
  const dateISO = (manDate.value || "").trim();
  if(!dateISO) return;

  const time = (manTime.value || "").trim();
  const address = (manAddr.value || "").trim();
  const notes = (manNotes.value || "").trim();

  // Require at least something meaningful
  if(!time && !address && !notes){
    manualDlg.close();
    return;
  }

  manual = loadManual(); // re-load in case
  const arr = Array.isArray(manual[dateISO]) ? manual[dateISO] : [];

  if(editingManualId){
    const i = arr.findIndex(x=>x.id===editingManualId);
    if(i>=0){
      arr[i] = { ...arr[i], time, address, notes };
    }else{
      arr.push({ id: editingManualId, time, address, notes });
    }
  }else{
    arr.push({ id: uid(), time, address, notes });
  }

  manual[dateISO] = arr;
  saveManual(manual);

  // Keep UI on that date
  setSelected(new Date(dateISO));
  manualDlg.close();
  render();
};

manDelete.onclick = ()=>{
  const dateISO = (manDate.value || "").trim();
  if(!dateISO || !editingManualId) return;

  if(!confirm("Delete this manual appointment?")) return;

  manual = loadManual();
  const arr = Array.isArray(manual[dateISO]) ? manual[dateISO] : [];
  manual[dateISO] = arr.filter(x=>x.id !== editingManualId);

  if(manual[dateISO].length === 0) delete manual[dateISO];

  saveManual(manual);
  manualDlg.close();
  render();
};

render();
</script>
</body>
</html>
